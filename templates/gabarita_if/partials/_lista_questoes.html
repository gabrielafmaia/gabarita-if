{% load static %}
{% for questao in objects %}
<div class="col">
  <div class="card mb-3" style="background-color: var(--bs-white); padding: 32px">
    <div class="card-header d-flex flex-column gap-4 text-center mb-4" style="all: unset">
      <div class="d-flex gap-2 gap-5 align-items-center justify-content-center">
        {% if questoes.has_previous %}
        <a href="?p={{ questoes.previous_page_number }}">
          <i class="fa-solid fa-arrow-left" style="margin-right: 0.5rem"></i>
          Anterior
        </a>
        {% else %}
        <a href="#" class="disable">
          <i class="fa-solid fa-arrow-left" style="margin-right: 0.5rem"></i>
          Anterior
        </a>
        {% endif %}

        <div class="d-flex align-items-center">
          <div class="m-0">
            <span
              >Questão <span class="fw-semibold">{{ objects.number }}</span> de {{ objects.paginator.num_pages }}</span
            >
          </div>
        </div>

        {% if objects.has_next %}
        <a href="?p={{ objects.next_page_number }}">
          Próxima<i class="fa-solid fa-arrow-right" style="margin-left: 0.5rem"></i>
        </a>
        {% else %}
        <a href="#" class="disable">Próxima<i class="fa-solid fa-arrow-right" style="margin-left: 0.5rem"></i> </a>
        {% endif %}
      </div>
    </div>

    <div class="card-body">
      <!-- Textos de apoio -->
      {% if questao.texto_de_apoio.all %}
      <div class="mb-4">
        {% for texto in questao.texto_de_apoio.all %}
        <div class="accordion mb-2">
          <div class="accordion-item">
            <h2 class="accordion-header">
              <button
                class="accordion-button collapsed"
                type="button"
                data-bs-toggle="collapse"
                data-bs-target="#collapse{{ questao.id }}_{{ forloop.counter }}"
              >
                {{ texto.titulo }}
              </button>
            </h2>
            <div id="collapse{{ questao.id }}_{{ forloop.counter }}" class="accordion-collapse collapse">
              <div class="accordion-body">
                <p class="m-0" style="text-align: justify">{{ texto.texto }}</p>
                {% if texto.imagem %}
                <img src="{{ texto.imagem.url }}" class="img-fluid" alt="{{ texto.titulo }}" style="width: 30rem" />
                {% endif %}
              </div>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
      {% endif %}

      <p class="mb-4">{{ questao.enunciado }}</p>
      {% if questao.imagem %}
      <img src="{{ questao.imagem.url }}" class="img-fluid mb-4" alt="" style="width: 15rem">
      {% endif %}

      <div class="resposta-area">
        <form class="alternativas-form d-flex flex-column gap-3" data-questao-id="{{ questao.id }}">
          {% csrf_token %} 
          {% for letra, texto in questao.alternativas_dict.items %}
          <div
            class="d-flex align-items-center rounded-lg min-h-16 bg-light alternativa-container"
            style="padding: 16px"
            onclick="selectAlternative(this, {{ questao.id }}, '{{ letra }}')"
          >
            <div class="d-flex align-items-center w-100">
              <div class="d-flex align-items-center gap-3 pe-3 m-auto flex-grow-1">
                <label class="fw-semibold text-lg cursor-pointer">{{ letra }})</label>
                <input
                  class="form-check-input custom-radio"
                  type="radio"
                  name="alternativa_{{ questao.id }}"
                  value="{{ letra }}"
                  id="alt_{{ questao.id }}_{{ letra }}"
                />
                <p class="m-0">{{ texto }}</p>
              </div>
            </div>
          </div>
          {% endfor %}

          <!-- Feedback Div -->
          <div id="feedback-{{ questao.id }}" class="feedback-container my-3" style="display: none">
            <div class="card border-0">
              <div class="card-body p-4">
                <div class="row align-items-center">
                  <div class="col-auto">
                    <div class="feedback-img">
                      <img
                        src="{% static 'assets/img/10.png' %}"
                        alt=""
                        id="feedback-success-{{ questao.id }}"
                        style="display: none; width: 6rem !important;"
                      />
                      <img
                        src="{% static 'assets/img/9.png' %}"
                        alt=""
                        id="feedback-error-{{ questao.id }}"
                        style="display: none;  width: 6.5rem !important;"
                      />
                    </div>
                  </div>
                  <div class="col ms-2 m-auto">
                    <h4 class="feedback-title mb-2" id="feedback-title-{{ questao.id }}"></h4>
                    <p class="feedback-message mb-0" id="feedback-message-{{ questao.id }}"></p>
                    <p class="feedback-details text-muted mb-0" id="feedback-details-{{ questao.id }}"></p>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Conteúdo Adicional -->
          <div id="conteudo-{{ questao.id }}" style="display: none">
            <div>
              <ul class="nav nav-tabs" id="abasConteudo{{ questao.id }}" role="tablist">
                <li class="nav-item" role="presentation">
                  <button
                    class="nav-link active"
                    id="gabarito-tab-{{ questao.id }}"
                    data-bs-toggle="tab"
                    data-bs-target="#gabarito-{{ questao.id }}"
                    type="button"
                    role="tab"
                  >
                    Gabarito comentado
                  </button>
                </li>
                {% if questao.video_solucao %}
                <li class="nav-item" role="presentation">
                  <button
                    class="nav-link"
                    id="video-tab-{{ questao.id }}"
                    data-bs-toggle="tab"
                    data-bs-target="#video-{{ questao.id }}"
                    type="button"
                    role="tab"
                  >
                    Vídeo solução
                  </button>
                </li>
                {% endif %}
              </ul>

              <div
                class="tab-content border border-top-0 rounded-bottom"
                style="background: linear-gradient(to bottom right, rgb(211, 245, 234, 0.2), var(--bs-gray-100))"
              >
                <div class="tab-content p-4">
                  <!-- Gabarito comentado -->
                  <div class="tab-pane fade show active" id="gabarito-{{ questao.id }}" role="tabpanel">
                    <div class="gabarito-content">
                      <div class="d-flex align-items-start mb-3">
                        <div>
                          <p class="mb-0" style="line-height: 1.6">{{ questao.gabarito_comentado }}</p>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- Vídeo solução -->
                  {% if questao.video_solucao %}
                  <div class="tab-pane fade" id="video-{{ questao.id }}" role="tabpanel">
                    <div class="text-center">
                      <div class="mb-4">
                        <i class="fa-solid fa-video text-primary fa-3x mb-3"></i>
                        <h5 class="text-primary">Resolução em Vídeo</h5>
                        <p class="text-muted">Assista à explicação detalhada desta questão</p>
                      </div>
                      <a href="{{ questao.video_solucao }}" target="_blank" class="btn btn-primary btn-lg">
                        <i class="fa-solid fa-play me-2"></i>Assistir ao Vídeo
                      </a>
                    </div>
                  </div>
                  {% endif %}
                </div>
              </div>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>

  <div class="text-end form-btn">
    <button
      type="button"
      class="btn btn-primary"
      onclick="submitAnswer({{ questao.id }})"
      id="btn-responder-{{ questao.id }}"
    >
      Responder
    </button>
  </div>
</div>
{% endfor %} 

<script>
  let selectedAnswers = {};

  function selectAlternative(container, questaoId, alternativaLetra) {
    if (container.classList.contains("disabled")) return;

    const alternatives = document.querySelectorAll(`[data-questao-id="${questaoId}"] .alternativa-container`);

    alternatives.forEach((alt) => alt.classList.remove("selected"));
    container.classList.add("selected");

    const radio = document.getElementById(`alt_${questaoId}_${alternativaLetra}`);
    if (radio) {
      radio.checked = true;
      selectedAnswers[questaoId] = alternativaLetra;
      document.getElementById(`btn-responder-${questaoId}`).disabled = false;
    }
  }

  function submitAnswer(questaoId) {
    const selectedLetra = selectedAnswers[questaoId];
    if (!selectedLetra) {
      alert("Por favor, selecione uma alternativa antes de responder.");
      return;
    }

    const formData = new FormData();
    formData.append("questao_id", questaoId);
    formData.append("alternativa_letra", selectedLetra);
    formData.append("csrfmiddlewaretoken", document.querySelector("[name=csrfmiddlewaretoken]").value);

    fetch('{% url "gabarita_if:responder-questao" %}', {
      method: "POST",
      body: formData,
    })
      .then((response) => response.json())
      .then((data) => showResult(questaoId, data))
      .catch((error) => {
        console.error("Erro:", error);
        alert("Erro ao processar resposta. Tente novamente.");
      });
  }

  function showResult(questaoId, data) {
    const feedbackDiv = document.getElementById(`feedback-${questaoId}`);
    const conteudoDiv = document.getElementById(`conteudo-${questaoId}`);

    if (data.acertou) {
      showFeedback(
        questaoId,
        "Boa, futuro federal! Você acertou!",
        "Continue assim, você está mandando muito bem!",
        "",
        true
      );
    } else {
      const details = `A alternativa correta é a ${data.alternativa_correta}`;
      showFeedback(questaoId, "Poxa, futuro federal! Não foi dessa vez!", "", details, false);
    }

    feedbackDiv.style.display = "block";
    conteudoDiv.style.display = "block";
    highlightAlternatives(questaoId, data.alternativa_correta, selectedAnswers[questaoId]);
    document.getElementById(`btn-responder-${questaoId}`).disabled = true;
    disableAlternatives(questaoId);
  }

  function showFeedback(questaoId, title, message, details, isSuccess) {
    const feedbackCard = document.querySelector(`#feedback-${questaoId} .card`);

    document.getElementById(`feedback-title-${questaoId}`).textContent = title;
    document.getElementById(`feedback-message-${questaoId}`).textContent = message;
    document.getElementById(`feedback-details-${questaoId}`).textContent = details;

    if (isSuccess) {
      document.getElementById(`feedback-success-${questaoId}`).style.display = "block";
      document.getElementById(`feedback-error-${questaoId}`).style.display = "none";

      feedbackCard.classList.remove("feedback-error");
      feedbackCard.classList.add("feedback-success");
    } else {
      document.getElementById(`feedback-success-${questaoId}`).style.display = "none";
      document.getElementById(`feedback-error-${questaoId}`).style.display = "block";

      feedbackCard.classList.remove("feedback-success");
      feedbackCard.classList.add("feedback-error");
    }
  }

  function highlightAlternatives(questaoId, corretaletra, selecionadaLetra) {
    const alternatives = document.querySelectorAll(`[data-questao-id="${questaoId}"] .alternativa-container`);

    alternatives.forEach((container) => {
      const radio = container.querySelector('input[type="radio"]');

      if (radio && radio.value == corretaletra) {
        container.classList.remove("bg-light", "selected");
        container.classList.add("correta");
      } else if (radio && radio.value == selecionadaLetra && radio.value != corretaletra) {
        container.classList.remove("bg-light", "selected");
        container.classList.add("incorreta");
      }
    });
  }

  function disableAlternatives(questaoId) {
    const alternatives = document.querySelectorAll(`[data-questao-id="${questaoId}"] .alternativa-container`);

    alternatives.forEach((container) => {
      container.classList.add("disabled");
      container.style.cursor = "default";
      container.onclick = null;
    });
  }
  function showResult(questaoId, data) {
  const feedbackDiv = document.getElementById(`feedback-${questaoId}`);
  const conteudoDiv = document.getElementById(`conteudo-${questaoId}`);

  // Reinicia animação toda vez que o feedback aparece
  feedbackDiv.classList.remove("feedback-animate");
  void feedbackDiv.offsetWidth; // força reflow
  feedbackDiv.classList.add("feedback-animate");

  if (data.acertou) {
    showFeedback(
      questaoId,
      "Boa, futuro federal! Você acertou!",
      "Continue assim, você está mandando muito bem!",
      "",
      true
    );
  } else {
    const details = `A alternativa correta é a ${data.alternativa_correta}`;
    showFeedback(questaoId, "Poxa, futuro federal! Não foi dessa vez!", "", details, false);
  }

  feedbackDiv.style.display = "block";
  conteudoDiv.style.display = "block";
  highlightAlternatives(questaoId, data.alternativa_correta, selectedAnswers[questaoId]);
  document.getElementById(`btn-responder-${questaoId}`).disabled = true;
  disableAlternatives(questaoId);
}
</script>
