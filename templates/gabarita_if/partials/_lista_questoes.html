{% load static %} {% include "gabarita_if/partials/_filtro.html" %} {% for object in objects %}
<div class="col">
  <div class="card mb-3" style="background-color: var(--bs-white); padding: 32px">
    <div class="card-header d-flex flex-column gap-4 text-center mb-4" style="all: unset">
      <div class="d-flex gap-2 gap-5 align-items-center justify-content-center">
        {% if objects.has_previous %}
        <a
          href="?p={{ objects.previous_page_number }}{% for key, value in request.GET.items %}{% if key != 'p' %}&{{ key }}={{ value }}{% endif %}{% endfor %}"
        >
          <i class="fa-solid fa-arrow-left" style="margin-right: 0.5rem"></i>
          Anterior
        </a>
        {% else %}
        <a href="#" class="disable" style="color: #6c757d; pointer-events: none; text-decoration: none">
          <i class="fa-solid fa-arrow-left" style="margin-right: 0.5rem"></i>
          Anterior
        </a>
        {% endif %}

        <div class="d-flex align-items-center">
          <div class="m-0">
            <span
              >Questão <span class="fw-semibold">{{ objects.number }}</span> de {{ objects.paginator.num_pages }}</span
            >
          </div>
        </div>

        {% if objects.has_next %}
        <a
          href="?p={{ objects.next_page_number }}{% for key, value in request.GET.items %}{% if key != 'p' %}&{{ key }}={{ value }}{% endif %}{% endfor %}"
        >
          Próxima<i class="fa-solid fa-arrow-right" style="margin-left: 0.5rem"></i>
        </a>
        {% else %}
        <a href="#" class="disable" style="color: #6c757d; pointer-events: none; text-decoration: none">
          Próxima<i class="fa-solid fa-arrow-right" style="margin-left: 0.5rem"></i>
        </a>
        {% endif %}
      </div>
    </div>

    <div class="card-body">
      <!-- Textos de apoio -->
      {% with textos_de_apoio=object.prova.textos_de_apoio.all %}
        {% if textos_de_apoio %}
        <h6>*Se necessário, responda a questão com base nos textos abaixo.</h6>
          <div class="mb-4">
            {% for texto in textos_de_apoio %}
            <div class="accordion mb-2">
              <div class="accordion-item">
                <h2 class="accordion-header">
                  <button
                    class="accordion-button collapsed"
                    type="button"
                    data-bs-toggle="collapse"
                    data-bs-target="#collapse{{ object.id }}_{{ forloop.counter }}"
                  >
                    {{ texto.titulo }}
                  </button>
                </h2>
                <div id="collapse{{ object.id }}_{{ forloop.counter }}" class="accordion-collapse collapse">
                  <div class="accordion-body">
                    <p class="m-0" style="text-align: justify">{{ texto.texto }}</p>
                    {% if texto.imagem %}
                    <img src="{{ texto.imagem.url }}" class="img-fluid" alt="{{ texto.titulo }}" style="width: 30rem" />
                    {% endif %}
                  </div>
                </div>
              </div>
            </div>
            {% endfor %}
          </div>
        {% else %}
          {% with textos_de_apoio=object.simulado.textos_de_apoio.all %}
            {% if textos_de_apoio %}
            <div class="mb-4">
              {% for texto in textos_de_apoio %}
              <div class="accordion mb-2">
                <div class="accordion-item">
                  <h2 class="accordion-header">
                    <button
                      class="accordion-button collapsed"
                      type="button"
                      data-bs-toggle="collapse"
                      data-bs-target="#collapse{{ object.id }}_{{ forloop.counter }}"
                    >
                      {{ texto.titulo }}
                    </button>
                  </h2>
                  <div id="collapse{{ object.id }}_{{ forloop.counter }}" class="accordion-collapse collapse">
                    <div class="accordion-body">
                      <p class="m-0" style="text-align: justify">{{ texto.texto }}</p>
                      {% if texto.imagem %}
                      <img src="{{ texto.imagem.url }}" class="img-fluid" alt="{{ texto.titulo }}" style="width: 30rem" />
                      {% endif %}
                    </div>
                  </div>
                </div>
              </div>
              {% endfor %}
            </div>
            {% endif %}
          {% endwith %}
        {% endif %}
      {% endwith %}

      <p class="mb-4">{{ object.enunciado }}</p>
      {% if object.imagem %}
      <img src="{{ object.imagem.url }}" class="img-fluid mb-4" alt="" style="width: 15rem" />
      {% endif %}

      <div class="resposta-area">
        <form class="alternativas-form d-flex flex-column gap-3" data-questao-id="{{ object.id }}">
          {% csrf_token %} {% for letra, texto in object.alternativas.items %}
          <div
            class="d-flex align-items-center rounded-lg min-h-16 bg-light alternativa-container"
            style="padding: 16px"
            onclick="selectAlternative(this, {{ object.id }}, '{{ letra }}')"
          >
            <div class="d-flex align-items-center w-100">
              <div class="d-flex align-items-center gap-3 pe-3 m-auto flex-grow-1">
                <label class="fw-semibold text-lg cursor-pointer">{{ letra }})</label>
                <input
                  class="form-check-input custom-radio"
                  type="radio"
                  name="alternativa_{{ object.id }}"
                  value="{{ letra }}"
                  id="alt_{{ object.id }}_{{ forloop.counter }}"
                />
                <p class="m-0">{{ texto }}</p>
              </div>
            </div>
          </div>
          {% endfor %}

          <!-- Feedback Div -->
          <div id="feedback-{{ object.id }}" class="feedback-container my-3" style="display: none">
            <div class="card border-0">
              <div class="card-body p-4">
                <div class="row align-items-center">
                  <div class="col-auto">
                    <div class="feedback-img">
                      <img
                        src="{% static 'assets/img/10.png' %}"
                        alt=""
                        id="feedback-success-{{ object.id }}"
                        style="display: none; width: 6rem !important"
                      />
                      <img
                        src="{% static 'assets/img/9.png' %}"
                        alt=""
                        id="feedback-error-{{ object.id }}"
                        style="display: none; width: 6.5rem !important"
                      />
                    </div>
                  </div>
                  <div class="col ms-2 m-auto">
                    <h4 class="feedback-title mb-2" id="feedback-title-{{ object.id }}"></h4>
                    <p class="feedback-message mb-0" id="feedback-message-{{ object.id }}"></p>
                    <p class="feedback-details text-muted mb-0" id="feedback-details-{{ object.id }}"></p>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Conteúdo Adicional -->
          <div id="conteudo-{{ object.id }}" style="display: none">
            <div>
              <ul class="nav nav-tabs" id="abasConteudo{{ object.id }}" role="tablist">
                <li class="nav-item" role="presentation">
                  <button
                    class="nav-link active"
                    id="gabarito-tab-{{ object.id }}"
                    data-bs-toggle="tab"
                    data-bs-target="#gabarito-{{ object.id }}"
                    type="button"
                    role="tab"
                  >
                    Gabarito comentado
                  </button>
                </li>
                {% if object.video_solucao %}
                <li class="nav-item" role="presentation">
                  <button
                    class="nav-link"
                    id="video-tab-{{ object.id }}"
                    data-bs-toggle="tab"
                    data-bs-target="#video-{{ object.id }}"
                    type="button"
                    role="tab"
                  >
                    Vídeo solução
                  </button>
                </li>
                {% endif %}
              </ul>

              <div
                class="tab-content border border-top-0 rounded-bottom"
                style="background: linear-gradient(to bottom right, rgb(211, 245, 234, 0.2), var(--bs-gray-100))"
              >
                <div class="tab-content p-4">
                  <!-- Gabarito comentado -->
                  <div class="tab-pane fade show active" id="gabarito-{{ object.id }}" role="tabpanel">
                    <div class="gabarito-content">
                      <div class="d-flex align-items-start mb-3">
                        <div>
                          <p class="mb-0" style="line-height: 1.6">{{ object.gabarito_comentado }}</p>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- Vídeo solução -->
                  {% if object.video_solucao %}
                  <div class="tab-pane fade" id="video-{{ object.id }}" role="tabpanel">
                    <div class="text-center">
                      <div class="mb-4">
                        <i class="fa-solid fa-video text-primary fa-3x mb-3"></i>
                        <h5 class="text-primary">Resolução em Vídeo</h5>
                        <p class="text-muted">Assista à explicação detalhada desta questão</p>
                      </div>
                      <a href="{{ object.video_solucao }}" target="_blank" class="btn btn-primary btn-lg">
                        <i class="fa-solid fa-play me-2"></i>Assistir ao Vídeo
                      </a>
                    </div>
                  </div>
                  {% endif %}
                </div>
              </div>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>

  <div class="text-end form-btn">
    <button
      type="button"
      class="btn btn-primary"
      onclick="submitAnswer({{ object.id }})"
      id="btn-responder-{{ object.id }}"
    >
      Responder
    </button>
  </div>
</div>
{% endfor %}

<script>
  let selectedAnswers = {};

  function selectAlternative(container, questaoId, alternativaLetra) {
    if (container.classList.contains("disabled")) return;

    const alternatives = document.querySelectorAll(`[data-questao-id="${questaoId}"] .alternativa-container`);

    alternatives.forEach((alt) => alt.classList.remove("selected"));
    container.classList.add("selected");

    const radio = document.getElementById(`alt_${questaoId}_${alternativaLetra}`);
    if (radio) {
      radio.checked = true;
      selectedAnswers[questaoId] = alternativaLetra;
      document.getElementById(`btn-responder-${questaoId}`).disabled = false;
    }
  }

  function submitAnswer(questaoId) {
    const selectedLetra = selectedAnswers[questaoId];
    if (!selectedLetra) {
      alert("Por favor, selecione uma alternativa antes de responder.");
      return;
    }

    const formData = new FormData();
    formData.append("questao_id", questaoId);
    formData.append("alternativa_letra", selectedLetra);
    formData.append("csrfmiddlewaretoken", document.querySelector("[name=csrfmiddlewaretoken]").value);

    fetch('{% url "gabarita_if:responder-questao" %}', {
      method: "POST",
      body: formData,
    })
      .then((response) => response.json())
      .then((data) => showResult(questaoId, data))
      .catch((error) => {
        console.error("Erro:", error);
        alert("Erro ao processar resposta. Tente novamente.");
      });
  }

  function showResult(questaoId, data) {
    const feedbackDiv = document.getElementById(`feedback-${questaoId}`);
    const conteudoDiv = document.getElementById(`conteudo-${questaoId}`);

    if (data.acertou) {
      showFeedback(
        questaoId,
        "Boa, futuro federal! Você acertou!",
        "Continue assim, você está mandando muito bem!",
        "",
        true
      );
    } else {
      const details = `A alternativa correta é a ${data.alternativa_correta}`;
      showFeedback(questaoId, "Poxa, futuro federal! Não foi dessa vez!", "", details, false);
    }

    feedbackDiv.style.display = "block";
    conteudoDiv.style.display = "block";
    highlightAlternatives(questaoId, data.alternativa_correta, selectedAnswers[questaoId]);
    document.getElementById(`btn-responder-${questaoId}`).disabled = true;
    disableAlternatives(questaoId);
  }

  function showFeedback(questaoId, title, message, details, isSuccess) {
    const feedbackCard = document.querySelector(`#feedback-${questaoId} .card`);

    document.getElementById(`feedback-title-${questaoId}`).textContent = title;
    document.getElementById(`feedback-message-${questaoId}`).textContent = message;
    document.getElementById(`feedback-details-${questaoId}`).textContent = details;

    if (isSuccess) {
      document.getElementById(`feedback-success-${questaoId}`).style.display = "block";
      document.getElementById(`feedback-error-${questaoId}`).style.display = "none";

      feedbackCard.classList.remove("feedback-error");
      feedbackCard.classList.add("feedback-success");
    } else {
      document.getElementById(`feedback-success-${questaoId}`).style.display = "none";
      document.getElementById(`feedback-error-${questaoId}`).style.display = "block";

      feedbackCard.classList.remove("feedback-success");
      feedbackCard.classList.add("feedback-error");
    }
  }

  function highlightAlternatives(questaoId, corretaletra, selecionadaLetra) {
    const alternatives = document.querySelectorAll(`[data-questao-id="${questaoId}"] .alternativa-container`);

    alternatives.forEach((container) => {
      const radio = container.querySelector('input[type="radio"]');

      if (radio && radio.value == corretaletra) {
        container.classList.remove("bg-light", "selected");
        container.classList.add("correta");
      } else if (radio && radio.value == selecionadaLetra && radio.value != corretaletra) {
        container.classList.remove("bg-light", "selected");
        container.classList.add("incorreta");
      }
    });
  }

  function disableAlternatives(questaoId) {
    const alternatives = document.querySelectorAll(`[data-questao-id="${questaoId}"] .alternativa-container`);

    alternatives.forEach((container) => {
      container.classList.add("disabled");
      container.style.cursor = "default";
      container.onclick = null;
    });
  }
</script>
